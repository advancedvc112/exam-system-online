# 高并发在线考试系统 - 性能压力测试

## 测试脚本说明

本测试脚本用于模拟高并发场景下的考试系统压力测试，覆盖以下关键场景：

### 测试场景

1. **场景1: 并发获取考试令牌**
   - 模拟大量考生同时获取考试令牌
   - 测试分布式锁和令牌获取的性能

2. **场景2: 并发进入考试**
   - 模拟考试开始前大量考生同时进入考试
   - 测试考试令牌验证和考试记录创建的性能

3. **场景3: 并发保存答案（高频操作）**
   - 模拟考试中大量考生频繁修改答案
   - 测试Redis缓存和批量同步的性能
   - **这是最高频的操作，压力最大**

4. **场景4: 并发提交考试**
   - 模拟考试时间耗尽时大量考生同时提交
   - 测试限流队列和批量提交的性能

## 使用方法

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置参数

编辑 `performance_test.py`，修改以下配置：

```python
BASE_URL = "http://localhost:8080"  # 修改为实际的服务地址
TOTAL_STUDENTS = 1000  # 总考生数
CONCURRENT_USERS = 100  # 并发用户数
EXAM_ID = 1  # 考试ID（需要先创建）
QUESTION_COUNT = 50  # 题目数量
```

### 3. 准备测试数据

**前置条件**：
1. 确保系统已启动
2. 确保已创建考试（EXAM_ID）
3. 确保管理员已开启考试（考试状态为 `in_progress`）
4. 确保已创建测试学生账号（或使用注册功能）

**创建测试学生账号**（可选）：
```python
# 在脚本中启用注册功能
register_student(f"student_{i}", "123456")
```

### 4. 运行测试

```bash
python performance_test.py
```

## 测试结果解读

### 输出指标

- **总请求数**: 该场景的总请求数
- **成功/失败数**: 成功和失败的请求数及百分比
- **平均响应时间**: 所有请求的平均响应时间（毫秒）
- **最小/最大响应时间**: 响应时间的范围
- **P95/P99响应时间**: 95%和99%的请求响应时间
- **QPS**: 每秒处理的请求数

### 性能指标参考

| 场景 | 目标QPS | 目标响应时间 |
|------|---------|-------------|
| 获取令牌 | >1000 | <100ms |
| 进入考试 | >500 | <200ms |
| 保存答案 | >5000 | <50ms |
| 提交考试 | >200 | <500ms |

## 测试建议

### 渐进式测试

1. **小规模测试**（100考生，10并发）
   - 验证功能正确性
   - 检查是否有明显性能问题

2. **中等规模测试**（500考生，50并发）
   - 测试系统在中等负载下的表现
   - 观察响应时间变化

3. **大规模测试**（1000+考生，100+并发）
   - 测试系统极限性能
   - 观察是否有性能瓶颈

### 监控指标

在测试过程中，建议监控：

1. **服务器资源**
   - CPU使用率
   - 内存使用率
   - 网络IO
   - 磁盘IO

2. **Redis性能**
   - Redis连接数
   - Redis内存使用
   - Redis命令执行时间

3. **数据库性能**
   - 数据库连接数
   - SQL执行时间
   - 慢查询日志

4. **应用日志**
   - 错误日志
   - 异常堆栈
   - 业务日志

## 常见问题

### 1. 连接超时

**原因**: 并发过高，服务器无法及时响应

**解决**: 
- 降低 `CONCURRENT_USERS`
- 增加服务器资源
- 检查网络延迟

### 2. 大量失败请求

**原因**: 
- 考试令牌已过期
- 考试状态不正确
- 学生账号不存在

**解决**:
- 确保考试已开启
- 确保学生账号已创建
- 检查JWT token是否有效

### 3. 响应时间过长

**原因**: 
- 数据库压力过大
- Redis连接数不足
- 服务器资源不足

**解决**:
- 检查数据库连接池配置
- 检查Redis连接池配置
- 增加服务器资源

## 扩展测试

### 自定义测试场景

可以修改脚本添加自定义测试场景：

```python
def custom_test_scenario():
    """自定义测试场景"""
    # 你的测试逻辑
    pass
```

### 压力测试工具

除了Python脚本，也可以使用专业工具：

1. **JMeter**: 图形化压力测试工具
2. **Apache Bench (ab)**: 简单的HTTP压力测试工具
3. **wrk**: 高性能HTTP压力测试工具
4. **Locust**: Python编写的分布式压力测试工具

## 注意事项

1. **测试环境**: 建议在独立的测试环境运行，避免影响生产环境
2. **数据清理**: 测试后清理测试数据，避免影响后续测试
3. **资源监控**: 测试过程中密切监控服务器资源
4. **逐步加压**: 不要一开始就使用最大并发，逐步增加压力

